# 体感直升飞机制作

> 很早的时候就在做飞机的体感控制,最开始做的是四旋翼飞机,后来因为四旋翼飞机飞行的稳定性安全和成本等诸多问题我放弃了四旋翼方案,直升飞机相对于四旋翼飞机最大的优点就是直升飞机可以在空中悬停,这个对于体感控制来说很关键,这样的话更方便于测试,四旋翼飞机不是不可以悬停,只是悬停的飞机成本太高,还有不得不承认,四旋翼飞机的控制难度要明显高于直升飞机,这一期我带领大家分析和制作体感直升飞机,期中的上位机程序,体感算法,Arduino的驱动数字电位器的接口程序可以私下联系我,早期的程序我已经做了更新,但是只是测试版,我很乐意帮助很想了解kinect的朋友们.qq:471170387


###一 通讯


从自动控制的角度来说,直升飞机的控制方法有一下两种:

>第一种:间接控制遥控器

>第二种:自制遥控器直接控制

当然我们要承认后者的控制精度,实时性,操作难度要远高于第一种,第一种控制说白了,就是自制一个摇杆,不过这个摇杆的话,嗯,不是普通的摇杆,他具体来说应该叫可编程数字电位器,再说白了,就是可控电阻,接下来大家看一看图片就懂了.....

![](http://doask.qiniudn.com/feiji1.png)

然后就是第二种了,这种方法我曾经试过,但是失败了,大致原理就是截获飞机和遥控器的通讯,也就类似于当年什么一战二战时候截获电报的感觉.....

要知道,这个”密电”是不会公开的,就像当年的战争,电报密文不会人手都有一样,但是只要知道事物的基本原理,就不难得到办法,截获方法如下:

首先要了解发射接手信号都是要有芯片的,他们负责传送数据,接受数据,仅仅就是这种功能,然而芯片的通信最简单的来说会有RXD,TXD引脚,作为芯片还会必不可少的有GND引脚,只要知道了这三个引脚的位置,那就可以接上2303芯片直接到电脑上打开串口,然后让芯片工作,进而找到合适频段,截获数据,示意图如下.

![](http://doask.qiniudn.com/feiji2.png)

原理上看着很简单,但是实施起来遇到如下问题很难解决:

>1.	连接好电路后,无法确定波特率,不同波特率会收到不同数据.
2.	数据结束到后无法找到规律,不能总结出通讯协议
3.	关于通讯为了稳定,更易于控制,往往通讯是双向的,这样就增加了截获难度.
4.	综上几点都是硬伤,数据截获成功率极低,所以后来我沮丧地放弃了.....

![](http://doask.qiniudn.com/feiji3.png)

上图仅为祭奠当年的心情.......
当然以上遇到的问题勇敢的人完全可以通过自己开发主板,制作飞控来解决.....

###二 解决方案

故,我选择了第一种通讯方式,这种控制还是比较靠谱....接下来说说怎么实现吧~看图说话:

![](http://doask.qiniudn.com/feiji4.png)

图片是附带解说的,我们接下来要做的事情就是:

>1.	拆开直升飞机遥控器,把原来的模拟电位器(摇杆)拆下来,保留焊点(破坏了就不好玩了,用徐老师的话说就是破坏公物有的时候叫搞破坏)拆好之后呢,注意找个小盒子,装好螺丝,器件,这绝对是个好习惯......平时要注意这些细节,这决定着很多事......
2.	仔细阅读X9313WP数字电位器的芯片手册(我会把资料附在附件里),注意芯片各个引脚功能,基本电路搭建方法,熟悉之后继续......
3.	编写下位机程序,也就是如何让X9313阻值听你的!这其中就涉及到通讯的问题.也就是说当Arduino驱动数字电位器的时候,接到”某某”指令后,数字电位器动作,改变阻值.
4.	编写上位机程序,在Processing下编写上位机程序,调用SimpleOpenNI库,得到Kinect数据流,获取人体信息,这些信息转化成通讯信息即上文所说的”某某”指令,传递给Arduino.
5.	然后,然后就测试吧,基本上成了~全家福如下图

![](http://doask.qiniudn.com/feiji5.png)

以上说的都很轻松,其实他真的也不难,关键是编程......

###三数字电位器驱动程序交流

大家首先要了解一下数字电位器X9313的工作原理:

如图为X9313数字电位器的引脚图:

![](http://doask.qiniudn.com/feiji6.png)

我用的X9313芯片是DIP封装的,一共八个引脚,如上图所示.
VCC,VSS科普一下如图:
Vcc Vdd 是高电平接入端,Vee Vss是负极接入端.

![](http://doask.qiniudn.com/feiji7.png)

3号引脚RH/VH, 6号引脚RL/VL和5号引脚RW/VW相当于滑动变阻器的三个抽头,其中5号引脚是活动抽头,介于3号6号引脚之间运动,期中X9313WP型号的电位器,是10千欧的,数字电位器是32阶的,32阶的意思就是将10千欧分成31份,大约每份330欧姆,也就是说,电位器在动作的时候他的最小精度,就是330欧姆,在原理框图中也就是芯片的基本引脚,由后色的标号2掌控者12,23,之间阻值的变化,期中13之间的电阻是10千欧(当上电后,1或3接地之后测量13之间是10千欧)下图的右边详细原理图中可以清楚的看出1,2,3之间的变化关系,其中2 被传输门的开关控制着,开关的有规律闭合断开会引起阻值的明显变化,这样的话就达到了电阻数控的目的我做了一张工作原理图,希望大家理解深刻.如下图

![](http://doask.qiniudn.com/feiji8.png)

上图中INC引脚,UD引脚,CS引脚为三个控制端,CS为片选端,当CS为低电平时,X9313被选中,此时才能接收UD和INC的信号,其中INC在一个脉冲的下降沿使计数器的数值增减1,如果UD为高电平,则滑动端向VH端滑动,Vw与VH之间电阻值减少一个台阶,也就是330欧姆,反之如果UN为低电平,则滑动端向VL端滑动.....但是要注意不是说滑动端VW会一直滑动下去,也不会滑动到边缘然后再循环滑动回来,如果你想储存滑动后的电阻值,那么有一个方法,就是让CS变为高电平,INC变为高电平,这样,计数器的值就被存储.
下图为引脚功能详细说明:

![](http://doask.qiniudn.com/feiji9.png)

写到这里,大家应该可以看懂这样的函数
```
void up()                  //定义一个增大阻值的函数
{
digitalWrite(cs,LOW);     //低电平选择芯片.
  digitalWrite(ud,HIGH);    //上升沿会触发向上移动滑动端事件.
  digitalWrite(inc,LOW);  //INC是低电平的时候才会触发移动方向由UD
                        决定(高上低下)
  delay(1);  //这个是延时目的是给9313足够的反应时间(实际上一个机
                  器周期就够了)
digitalWrite(inc,HIGH);   //为向上滑动做好准备
  digitalWrite(cs,HIGH);    //高电平取消片选即停止动作,同时为储存数
                           值做准备
}
```
函数digitalWrite()是Arduino的IDE编程语言,意思就是digitalWrite(x,y)x对应的引脚是有状态,期中状态为高低电平.同理向下滑动可以写成如下函数:

```
void down()
{
  digitalWrite(cs,LOW);
  digitalWrite(ud,LOW);
  digitalWrite(inc,LOW);
  delay(1);
  digitalWrite(inc,HIGH);
  digitalWrite(cs,HIGH);
}
```
相信这个down()函数也同样不难理解;

接下来就出现难题了,怎么定位?意思就是,怎么把数字电位器的阻值定到你想让它停下来的位置,你首先会想这样做,定义一个函数,比如说叫*Set_R()*;然后呢,空返回值,有参量,即*void Set_R(int i)*;其中”i”就是档位的数值,它是整数,且可自定义变化,从0到31;那内部的结构怎么办呢?首先设定档位要有一个标准,也就是参照物,没有参照物的话,档位的数值根本不成立.....这个理解吧,那么参照物设为哪里呢?起点或者是终点都可以,因为我们可以使滑动端很轻松的滑到其实位置和终止位置,所以参照系就可以定位起止位置或者是终止位置,ok开工~
```
int count=0;
int count2=0;
void Set_R ( int i )
{
  if(count2==0)    //死活都要进入循环的
{
  while(count<32) //清零预动作,任何时候count都会小于最高档位32的
{
  down();//执行档位下降函数,阶梯性降低档位(一次一档)
  delay(20);//这个20us 是有据可查的,芯片手册上明确的写着20us为最
                     低反应时间
  count++; //这句还是那么经典,当然不会例外,down()函数执行32次
}
/*以上的步骤就是为了找到参照系,这样的话便于档位的确定,如果你现在想定位档位8,那么你只要执行up() 八次就行了以此类推*/
  count=0;//接着进入变化档位状态
  while(count<i)//这个函数的i的值代表你打算定位的档位值
{
  up();
  delay(20);
  count++;
}
  count=0;
count2=1;此函数只执行一次,达到目的即止;
}
}
```

这里直说基本功能了,但是要想把代码有机的组合起来,那就得仔细考虑,细心斟酌了,建议这样操作:在我给你思路的前提下,自己写全代码,完美驱动X9313WP,然后扩展到3个x9313,同时也到到完美驱动.

###四 搭建测试平台

我经常会去YouTube看一些科技类的视频,深深地感觉到我解决问题的方法还不够科学,所以我打算构建一个科学的测试平台,顺利的完成预期目的,只有方法科学了,问题自然就会少了.具体思路如下:我们想看到数字电位器的变化那么我们就可以看看万用表的数值,但是万用表不一方面是不是很好好固定,数据的变动太快也是不容易被察觉的,当数字电位器增加到三个的时候,我们就不得不用三块表来同时观察度数,所以我们选择了电动机,也就是马达,直流电机直流电机可以直观的观禅转速变化,配合万用表效果很好,原理大致如下图:

![](http://doask.qiniudn.com/feiji10.png)

上图表达意思很简单,就是通过程序控制电机的转速,如果觉得转速不易观察可以安装上齿轮,或者是冰棍杆,橡皮泥之类的便于观察转速.然后连接原理图如下:

![](http://doask.qiniudn.com/feiji11.png)

然后如果感兴趣经济条件允许的话,也可以出一块电路板,这个板子是Arduino的数字电位器拓展板.效果图如下:

![](http://doask.qiniudn.com/feiji12.png)

这个平台搭建好之后,就可以测试很多程序了,其实在电路搭建上还有个需要注意的地方,那就是电阻电容的问题,适当加上的话会提高电气的稳定性,当然我这里没有加上(不加也可以但可能会影响一些程序的稳定性)此处推荐,INC,CS,UD在接单片机之前最好串联10千欧电
阻,在RH,RL两端分别按如图的接线连接电容,这样会明显降低噪声.稳定性大大增强.

![](http://doask.qiniudn.com/feiji13.png)

当你搭建好测试平台之后,就会发现自己其实省了很多时间,效率大大提高,有关于科学解决问题我也有过思考,真真正正的切切实实的发生在我们身边,我曾经试着调试我的机器人,上半身的调试其实是很简单的,以为我不必去考虑平衡的问题,也不怕机器人会摔倒,这样的话,我拥有了一个相对稳定的平台去调试我的机器人,当我很开心的解决了上半身的运动之后,一个痛疼的问题立刻就困扰到我了,什么呢?那就是如何调试下半身,要知道下半身的调试是很复杂的,最简单来说就是平衡问题,双足的调试在实验过程中一定会出现摔倒的现象,傻傻的我,竟然没想到好的解决办法,竟然没想到把机器人吊起来就可以很高效的调试......

其实当我想到可以吊起机器人进行顺利调试的时候,我马上想起了曾经在YouTube上看到的视频,他们调试的是一款工业机器人,他们调试的呃方法就是采用轨道加悬吊的方式......

顿时觉得解决问题高效的方法就是建造科学的操作平台.....

--------------------感慨结束--------------------

顺便了,不必多说了,还是上图吧,意思我大致讲讲吧,平台搭建起来的思路就是数控数字电位器,数控就是通过程序,人为的控制X9313WP芯片的的电阻输出,控制方式如下图共有两种可选(当然不止两种),一个是利用电脑,向arduino输入指令,在arduino里面,在既定的程序下,接收到对应的指令,arduino就会命令X9313WP芯片输出Arduino程序中对应的既定的阻值,另外还有一种方式,就是通过键盘输入,在Arduino内部也要事先写入程序,程序的内容就是接收键盘信息,改变X9313WP芯片输出阻值,后者调试起来更方便,但前者更考验编程的能力.具体思路如下图.

![](http://doask.qiniudn.com/feiji14.png)

>上图注释:随附件会给大家一款很好用的串口调试助手,高效便捷

###五 上位机程序及kinect 算法设计

想要飞机飞起来,首先要确定:

>1.	飞行方向对应的手势是什么
2.	手势确立之后要还求做到手势间不会相互干扰,手势独立,指令独立.
3.	如何实现起飞前的”对码”,即在正常遥控器上动作为上下拉动摇杆,在手势操作上有什么对应动作与摇杆动作作为替代.
4.	稳定控制不至于脱控.
5.	安全停机并退出程序.

下面我设计了一个操作界面.期中圆圈内的手可以跟随自己的手势动作,到达不同区域有不同的对应指令,以保证飞机飞行的控制方便.如下图:

![](http://doask.qiniudn.com/feiji15.png)

这张图片描绘的意思的是用操作者的右手,在图像界面里运动,粉色标尺位置对应不同指令,平衡位置相当于飞机的常态状态,反映在实际操作摇杆上的就是如下图状态(下图右手操作部分相当于上图):

![](http://doask.qiniudn.com/feiji16.png)

以上信息只解决了左右飞行,前后飞行的问题,但是作为直升飞机,在三维空间非行,我们还有为其添加上下飞行(油门)的动作,接下来前后的动作就由左手来玩完成,左手的摆动来控制飞机的油门大小上位机软件截图如下:

![](http://doask.qiniudn.com/feiji17.png)

如上所说,手的位置来确定飞机的飞行方向,当手处于白色圆圈里面时为对码区域,即常态区,当飞机刚要起飞的时候手的位置一定要调整到圆圈内部,就相当于遥控器处于常态的样子.红色代表油门大小,在kinect中油门的大小控制采用变量*get_angle来控制*,*get_angle*的大小获得方法为构造左手腕部,左侧肩部,左侧臀部三点形成三角形,三角形肩部位置的角度为*get_angle*,利用*get_angle*的大小映射(map函数)到油门的大小,这样的话就可以形象的控制飞机的油门大小了.在kinect编程里如下图所示(	便于说明没有刻意强调左右):

![](http://doask.qiniudn.com/feiji18.png)

*get_angle*的大小直接映射油门大小,也就是说左手制造的角度大小会控制油门,制造过程就是左手靠近身体与远离身体.
总体来说,飞行器的身体姿态方面草用的综合控制方法,如下图所示:

![](http://doask.qiniudn.com/feiji19.png)

人体在kinect中可以用enableMirror()函数来激活镜面关系,也就是说左右手的位置可以 在kinect中调换.上图中左手控制飞机的油门,右手控制飞机的方向,这样飞机就可以遵从人体姿态达到飞行的目的.

最终效果请看[链接](http://v.youku.com/v_show/id_XNjQ1NDU0MjMy.html),
这个演示视频连接是初版的程序和算法,我在这篇文章中写的是新版本的算法和程序设计,如果大家有什么要交流的请联我qq:471170387

